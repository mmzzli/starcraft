import{S as e}from"../@wry/@wry.ac881673.js";var t=function(){return Object.create(null)},n=Array.prototype,r=n.forEach,i=n.slice,s=function(){function e(e,n){void 0===e&&(e=!0),void 0===n&&(n=t),this.weakness=e,this.makeData=n}return e.prototype.lookup=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lookupArray(e)},e.prototype.lookupArray=function(e){var t=this;return r.call(e,(function(e){return t=t.getChildTrie(e)})),t.data||(t.data=this.makeData(i.call(e)))},e.prototype.getChildTrie=function(t){var n=this.weakness&&function(e){switch(typeof e){case"object":if(null===e)break;case"function":return!0}return!1}(t)?this.weak||(this.weak=new WeakMap):this.strong||(this.strong=new Map),r=n.get(t);return r||n.set(t,r=new e(this.weakness,this.makeData)),r},e}();function o(){}var u,a=function(){function e(e,t){void 0===e&&(e=1/0),void 0===t&&(t=o),this.max=e,this.dispose=t,this.map=new Map,this.newest=null,this.oldest=null}return e.prototype.has=function(e){return this.map.has(e)},e.prototype.get=function(e){var t=this.getNode(e);return t&&t.value},e.prototype.getNode=function(e){var t=this.map.get(e);if(t&&t!==this.newest){var n=t.older,r=t.newer;r&&(r.older=n),n&&(n.newer=r),t.older=this.newest,t.older.newer=t,t.newer=null,this.newest=t,t===this.oldest&&(this.oldest=r)}return t},e.prototype.set=function(e,t){var n=this.getNode(e);return n?n.value=t:(n={key:e,value:t,newer:null,older:this.newest},this.newest&&(this.newest.newer=n),this.newest=n,this.oldest=this.oldest||n,this.map.set(e,n),n.value)},e.prototype.clean=function(){for(;this.oldest&&this.map.size>this.max;)this.delete(this.oldest.key)},e.prototype.delete=function(e){var t=this.map.get(e);return!!t&&(t===this.newest&&(this.newest=t.older),t===this.oldest&&(this.oldest=t.newer),t.newer&&(t.newer.older=t.older),t.older&&(t.older.newer=t.newer),this.map.delete(e),this.dispose(t.value,e),!0)},e}(),l=new e,h=Object.prototype.hasOwnProperty,c=void 0===(u=Array.from)?function(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}:u;function p(e){var t=e.unsubscribe;"function"==typeof t&&(e.unsubscribe=void 0,t())}var f=[],d=100;function y(e,t){if(!e)throw new Error(t||"assertion failure")}function v(e){switch(e.length){case 0:throw new Error("unknown value");case 1:return e[0];case 2:throw e[1]}}var w=function(){function e(t){this.fn=t,this.parents=new Set,this.childValues=new Map,this.dirtyChildren=null,this.dirty=!0,this.recomputing=!1,this.value=[],this.deps=null,++e.count}return e.prototype.peek=function(){if(1===this.value.length&&!m(this))return g(this),this.value[0]},e.prototype.recompute=function(e){return y(!this.recomputing,"already recomputing"),g(this),m(this)?function(e,t){O(e),l.withValue(e,b,[e,t]),function(e,t){if("function"==typeof e.subscribe)try{p(e),e.unsubscribe=e.subscribe.apply(null,t)}catch(n){return e.setDirty(),!1}return!0}(e,t)&&function(e){if(e.dirty=!1,m(e))return;C(e)}(e);return v(e.value)}(this,e):v(this.value)},e.prototype.setDirty=function(){this.dirty||(this.dirty=!0,this.value.length=0,k(this),p(this))},e.prototype.dispose=function(){var e=this;this.setDirty(),O(this),V(this,(function(t,n){t.setDirty(),j(t,e)}))},e.prototype.forget=function(){this.dispose()},e.prototype.dependOn=function(e){e.add(this),this.deps||(this.deps=f.pop()||new Set),this.deps.add(e)},e.prototype.forgetDeps=function(){var e=this;this.deps&&(c(this.deps).forEach((function(t){return t.delete(e)})),this.deps.clear(),f.push(this.deps),this.deps=null)},e.count=0,e}();function g(e){var t=l.getValue();if(t)return e.parents.add(t),t.childValues.has(e)||t.childValues.set(e,[]),m(e)?D(t,e):z(t,e),t}function b(e,t){e.recomputing=!0,e.value.length=0;try{e.value[0]=e.fn.apply(null,t)}catch(n){e.value[1]=n}e.recomputing=!1}function m(e){return e.dirty||!(!e.dirtyChildren||!e.dirtyChildren.size)}function k(e){V(e,D)}function C(e){V(e,z)}function V(e,t){var n=e.parents.size;if(n)for(var r=c(e.parents),i=0;i<n;++i)t(r[i],e)}function D(e,t){y(e.childValues.has(t)),y(m(t));var n=!m(e);if(e.dirtyChildren){if(e.dirtyChildren.has(t))return}else e.dirtyChildren=f.pop()||new Set;e.dirtyChildren.add(t),n&&k(e)}function z(e,t){y(e.childValues.has(t)),y(!m(t));var n,r,i,s=e.childValues.get(t);0===s.length?e.childValues.set(t,t.value.slice(0)):(n=s,r=t.value,(i=n.length)>0&&i===r.length&&n[i-1]===r[i-1]||e.setDirty()),E(e,t),m(e)||C(e)}function E(e,t){var n=e.dirtyChildren;n&&(n.delete(t),0===n.size&&(f.length<d&&f.push(n),e.dirtyChildren=null))}function O(e){e.childValues.size>0&&e.childValues.forEach((function(t,n){j(e,n)})),e.forgetDeps(),y(null===e.dirtyChildren)}function j(e,t){t.parents.delete(e),e.childValues.delete(t),E(e,t)}var A={setDirty:!0,dispose:!0,forget:!0};function M(e){var t=new Map,n=e&&e.subscribe;function r(e){var r=l.getValue();if(r){var i=t.get(e);i||t.set(e,i=new Set),r.dependOn(i),"function"==typeof n&&(p(i),i.unsubscribe=n(e))}}return r.dirty=function(e,n){var r=t.get(e);if(r){var i=n&&h.call(A,n)?n:"setDirty";c(r).forEach((function(e){return e[i]()})),t.delete(e),p(r)}},r}function K(){var e=new s("function"==typeof WeakMap);return function(){return e.lookupArray(arguments)}}K();var S=new Set;function x(e,t){void 0===t&&(t=Object.create(null));var n=new a(t.max||Math.pow(2,16),(function(e){return e.dispose()})),r=t.keyArgs,i=t.makeCacheKey||K(),s=function(){var s=i.apply(null,r?r.apply(null,arguments):arguments);if(void 0===s)return e.apply(null,arguments);var o=n.get(s);o||(n.set(s,o=new w(e)),o.subscribe=t.subscribe,o.forget=function(){return n.delete(s)});var u=o.recompute(Array.prototype.slice.call(arguments));return n.set(s,o),S.add(n),l.hasValue()||(S.forEach((function(e){return e.clean()})),S.clear()),u};function o(e){var t=n.get(e);t&&t.setDirty()}function u(e){var t=n.get(e);if(t)return t.peek()}function h(e){return n.delete(e)}return Object.defineProperty(s,"size",{get:function(){return n.map.size},configurable:!1,enumerable:!1}),s.dirtyKey=o,s.dirty=function(){o(i.apply(null,arguments))},s.peekKey=u,s.peek=function(){return u(i.apply(null,arguments))},s.forgetKey=h,s.forget=function(){return h(i.apply(null,arguments))},s.makeCacheKey=i,s.getKey=r?function(){return i.apply(null,r.apply(null,arguments))}:i,Object.freeze(s)}export{M as d,x as w};
